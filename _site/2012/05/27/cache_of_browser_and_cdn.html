<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title></title>
	<meta name="description" content="">
	<meta name="author" content="">

	<meta name="viewport" content="width=device-width">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/highlight.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="stylesheet" media="screen" href="/css/screen.css">

	<script src="/js/libs/modernizr-2.5.3.min.js"></script>
</head>
<body class="gray">
<header>
</header>
<div role="main" id="main">
	<div class="post">
	<h1 id='cdn'>浏览器缓存和CDN</h1>

<p><em>作者：<a href='http://island205.github.com'>island205</a></em> 时间：2012-05-27</p>

<h2 id='id586'>引子</h2>

<p>前不久QA的同事来问我公司与CDN相关的事情，版本号是什么？浏览器缓存，CDN缓存的一些细节，为什么静态资源要有版本号？版本号怎么来的？如何就能刷缓存的？我虽然一一作答，但还是觉得对细节了解得不够清楚，遂打算起一篇文章好好研究一下浏览器的缓存和CDN，来探讨一下二者的来龙去脉。</p>

<h2 id='id587'>研究方法和工具</h2>

<p>从HTTP头讲起，一步步看看缓存是如何实现的，同时使用<a href='http://nodejs.org'>Node.js</a>来做实例服务器，使用<a href='http://coffeescript.org'>CoffeeScript</a>来做一些小实例，帮助大家理解，浏览器选定chrome，一是方面察看请求，二是浏览器间的对缓存的处理也不一致，仅用chrome理解原理为要。</p>

<p>开始我的探索之旅吧！</p>

<h2 id='id588'>第一个问题，浏览器一定会有缓存吗？</h2>

<p>首先介绍一个工具<a href='http://www.nirsoft.net/utils/chrome_cache_view.html'>Chrome缓存察看器</a>，可以用它来察看Chrome的缓存数据。为了便于后续的实验，我们先清掉chrome的缓存数据（方法自寻），然后使用察看其察看如下：</p>

<p><img alt='清除了缓存的chrome，可能还会有一到两个无法清除的与Google相关的缓存，不过没什么大碍，其他缓存已经被清除了' src='http://pic.yupoo.com/island205/BZR9gG7Y/medish.jpg' /></p>

<p>清除了缓存的chrome，可能还会有一到两个无法清除的与Google相关的缓存，不过没什么大碍，其他缓存已经被清除了。</p>

<p>用<code>Node.js</code>快速搭建一个最简单的服务器：</p>

<p><strong>server.coffee</strong></p>
<div class='highlight'><pre><code class='coffeescript'>	<span class='nx'>http</span><span class='o'>=</span><span class='nx'>require</span> <span class='s'>&quot;http&quot;</span>
	<span class='nx'>server</span><span class='o'>=</span><span class='nx'>http</span><span class='p'>.</span><span class='nx'>createServer</span> <span class='nf'>(req,res)-&gt;</span>
		<span class='c1'>#返回服务器当前的处理时间</span>
		<span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span> <span class='p'>(</span><span class='k'>new</span> <span class='nb'>Date</span><span class='p'>()).</span><span class='nx'>toString</span><span class='p'>()</span>
	<span class='nx'>server</span><span class='p'>.</span><span class='nx'>listen</span> <span class='mi'>1337</span><span class='p'>,</span><span class='s'>&#39;127.0.0.1&#39;</span>

	<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span> <span class='s'>&quot;Sever runing at http://127.0.0.1:1337&quot;</span>
</code></pre>
</div>
<p>使用<code>coffee -cw .</code>命令实时编译server.coffee成server.js，使用<a href='https://github.com/remy/nodemon'>nodemon</a>，来运行server.js，每次文件有修改时就不用手动重启node服务器了。</p>

<p>运行命令<code>nodemon server.js</code>，使用清掉了缓存的chrome访问<a href='http://127.0.0.1:1337'>http://127.0.0.1:1337</a>。</p>

<p>下图是chrome浏览器请求的情况，在调试工具的Network中可以察看请求头和相应头（在之后的实验中我直接使用文本来表示页面呈现的样子和关键的HTTP头）：</p>

<p><img alt='首次请求的情况' src='http://pic.yupoo.com/island205/BZRkumQT/medish.jpg' /></p>

<p>然后这是Chrome的缓存（同样之后直接使用关键的文本）：</p>

<p><img alt='chrome缓存' src='http://pic.yupoo.com/island205/BZRkOCtV/medish.jpg' /></p>	
<div>

</div>
<footer>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>

<!-- scripts concatenated and minified via ant build script-->
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>
<!-- end scripts-->

<script>
	var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
	(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
	g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
	s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>
